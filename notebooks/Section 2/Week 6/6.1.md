# Protocol 6.1: Hydrological Conditioning of Digital Elevation Models

**Document Version:** 1.0
**Date:** September 27, 2025
**Associated Project Task:** 6.1 - Perform hydrological conditioning on all DEMs.
**Corresponding Notebook:** `12_condition_dems.ipynb`

---

## 1. Objective

To process the raw, clipped DEM mosaic into a hydrologically correct digital surface, suitable for robust flow routing and the calculation of hydrological derivatives. This involves identifying and remediating common DEM artifacts, such as sinks and pits, that would otherwise invalidate subsequent analyses.

## 2. Rationale and Strategic Justification

This protocol is a foundational act of **creative world-building** within your digital landscape. A raw DEM is merely a grid of numbers; a hydrologically conditioned DEM is a beautiful and utilitarian scientific instrument, a surface upon which the physical laws of gravity and water flow can be realistically simulated. This task is a demonstration of **intellectual mastery**, as it requires understanding the subtle imperfections in digital data and applying a principled, physically-based correction.

The **tangible service** of this task is paramount: without a properly conditioned DEM, all downstream process-based covariates, particularly TWI and SPI, would be fundamentally flawed, producing fragmented flow paths and nonsensical results [cite: Geomorphology TDA Metrics Literature Review.md]. By meticulously "healing" the digital surface, you ensure the integrity of your entire process-prediction hypothesis ($H_2$).

## 3. Methodology and Key Decisions

### 3.1. The "Sink" Problem in Raw DEMs

Raw DEMs, especially those derived from LiDAR, often contain numerous small "sinks" or "pits"â€”cells or groups of cells that are lower than all their neighbors. These act as digital dams, artificially trapping the flow of simulated water and preventing the creation of a continuous, connected drainage network.

### 3.2. Optimal Algorithm Selection: Filling vs. Breaching

There are two primary methods for correcting sinks:

1.  **Depression Filling:** Raises the elevation of cells within a sink to the level of its lowest outlet or "pour point." This is a robust, conservative method that is widely used and computationally stable.
2.  **Depression Breaching:** Carves a narrow, downward-sloping channel from the sink to a lower-elevation cell downstream. While useful in some landscapes (like karst), it can create unrealistic, deeply incised artificial channels.

For this project, **Depression Filling (`FillDepressions`) is the optimal, enthusiast-grade choice** for creating a general-purpose, hydrologically conditioned surface. It ensures a fully connected flow network with minimal alteration to the broader landscape morphology.

### 3.3. The "Micro-Topography" Problem for Sensitive Indices

While a filled DEM is correct for general flow routing, highly sensitive indices like TWI can be disproportionately affected by minor, high-frequency roughness ("noise") in high-resolution DEMs. As your proposal notes, this can obscure the true landform-scale controls on hydrology [cite: Project Proposal Fall 2025.md].

To address this, we will implement a sophisticated, two-pronged approach:

1.  Create a primary, **filled DEM** for general-purpose analysis (e.g., slope, relief, stream delineation).
2.  Create a second, **smoothed DEM** specifically for the calculation of TWI and other sensitive indices. This involves applying a feature-preserving smoothing algorithm *to the filled DEM*. This is a critical detail that demonstrates intellectual mastery: we smooth the *hydrologically corrected* surface, preserving the connected drainage paths while reducing the micro-topographic noise that can distort process-proxy calculations.

## 4. Implementation Protocol (Jupyter Notebook Workflow)

### Step 1: Load Input Data
* **Input:** The clipped DEM mosaic from the data acquisition step (`data/interim/dem_mosaic_clipped.tif`).

### Step 2: Perform Primary Sink Filling
* **Input:** `dem_mosaic_clipped.tif`
* **Process:**
    1.  Use the `whitebox.fill_depressions()` tool. This is a high-performance, industry-standard algorithm.
    2.  Set the `fix_flats` parameter to `True` to ensure that flat areas are also resolved with a slight gradient, guaranteeing continuous flow.
* **Output:** `data/processed/dem_filled.tif`. This is the primary conditioned DEM.

### Step 3: Perform Targeted Smoothing for TWI
* **Input:** The newly created `dem_filled.tif`.
* **Process:**
    1.  Use the `whitebox.feature_preserving_smoothing()` tool. This algorithm is superior to a simple Gaussian blur as it smooths flat areas while preserving sharp breaks-in-slope, like ridges and channel banks.
    2.  Select an appropriate `filter` size (e.g., 5x5 or 11x11 cells) and `normal_diff_threshold` to control the degree of smoothing. These parameters should be explicitly documented in the notebook.
* **Output:** `data/processed/dem_smoothed_for_twi.tif`. This is the specialized DEM for sensitive indices.

### Step 4: Visualize and Verify
* **Process:**
    1.  Load all three DEMs (raw, filled, smoothed).
    2.  Create a "difference map" by subtracting the raw DEM from the filled DEM (`Filled - Raw`). This map will clearly highlight the areas (the sinks) that were modified.
    3.  Visualize the difference map to ensure that modifications are logical and primarily located in depressions.
    4.  Visually compare hillshades of the filled and smoothed DEMs to confirm that smoothing has reduced noise without destroying major landforms.

## 5. Deliverables

1.  **Primary Conditioned DEM:** A GeoTIFF file (`data/processed/dem_filled.tif`) that will be the input for most subsequent covariate generation tasks.
2.  **Specialized Smoothed DEM:** A GeoTIFF file (`data/processed/dem_smoothed_for_twi.tif`) that will be used specifically for calculating TWI and potentially other sensitive hydrological indices.
3.  **Jupyter Notebook (`12_condition_dems.ipynb`)**: A fully executed notebook containing the conditioning and smoothing workflows, parameter documentation, and the critical verification visualizations (e.g., difference maps, hillshade comparisons).

## 6. Quality Control Checklist

* [ ] The `fill_depressions` tool runs to completion without errors.
* [ ] The difference map clearly shows that modifications are confined to topographic depressions.
* [ ] The smoothed DEM shows a reduction in fine-scale noise but retains the integrity of major ridges and valleys.
* [ ] Both output DEMs are co-registered with the project's analysis grid (same extent, CRS, cell size).
* [ ] All steps and parameters are documented and reproducible in the Jupyter Notebook.****