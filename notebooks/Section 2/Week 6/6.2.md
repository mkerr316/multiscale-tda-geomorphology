# Protocol 6.2: Generating Multiscale Geomorphometric Covariates

**Document Version:** 1.0
**Date:** September 27, 2025
**Associated Project Task:** 6.2 - Generate all Tier 1 and Tier 2 covariate layers at the empirically-derived characteristic scales.
**Corresponding Notebook:** `13_generate_covariates.ipynb`

---

## 1. Objective

To execute the primary geoprocessing workflow that generates the complete suite of Tier 1 (Foundational) and Tier 2 (Process-Proxy) covariate rasters. This protocol explicitly uses the "characteristic scales" (i.e., analysis window sizes) that were empirically determined in the pilot analysis phase (Protocol 5.1) to ensure that the generated metrics are geomorphologically meaningful and optimally tuned to the study landscapes.

## 2. Rationale and Strategic Justification

This protocol is a central act of **creative world-building**. You are taking the two beautiful, clean DEM surfaces created in the previous step and using them as a canvas to paint a rich, multi-dimensional portrait of the landscape. Each covariate layer is a new lens, a new layer of color and texture that reveals a different aspect of the geomorphic system. This is an act of **intellectual mastery** because it moves beyond default parameters, instead applying a custom, data-driven set of "characteristic scales" to create a bespoke analytical framework.

The **tangible service** of this task is immense: it produces the core predictor variables that will form the backbone of your entire statistical analysis. The quality, accuracy, and thoughtful design of these layers will directly determine the success of both the landscape characterization ($H_1$) and process prediction ($H_2$) hypotheses. This is the moment where your structured, idealistic vision for a better way to describe landscapes is made real through code.

## 3. Implementation Protocol (Jupyter Notebook Workflow)

### Step 1: Initialize and Define Scales
* **Input:**
    * The primary conditioned DEM (`data/processed/dem_filled.tif`).
    * The specialized smoothed DEM (`data/processed/dem_smoothed_for_twi.tif`).
* **Process:**
    1.  Load the DEMs as `rioxarray` objects.
    2.  **Define Characteristic Scales:** At the top of the notebook, explicitly define the empirically-derived characteristic scales (in pixels) that were determined during the pilot power analysis (`09_power_analysis.ipynb`). For example:
        * `local_scale = 3` (e.g., ~30m)
        * `hillslope_scale = 9` (e.g., ~90m)
        * `catchment_scale = 27` (e.g., ~270m)
    3.  This ensures these critical parameters are transparent and easily modifiable.

### Step 2: Generate Tier 1 (Foundational) Covariates
All Tier 1 covariates are derived from the primary conditioned DEM (`dem_filled.tif`).

* **Slope Gradient:**
    * Use `whitebox.slope()` to generate a continuous slope raster.
* **Multiscale Local Relief:**
    * Loop through your defined characteristic scales (`local_scale`, `hillslope_scale`, etc.).
    * In each iteration, use `whitebox.max_elevation_deviation()` or a similar moving-window function with the corresponding window size.
    * Save each output with a descriptive name (e.g., `local_relief_3px.tif`).
* **Multiscale Wavelet-Based Roughness:**
    * This is the most sophisticated Tier 1 metric and the optimal replacement for standard curvature.
    * Loop through the characteristic scales.
    * For each scale, develop a function (potentially parallelized with Dask) that:
        1.  Applies a 2D Discrete Wavelet Transform (using `pywt`) to a moving window of the DEM.
        2.  Calculates a summary statistic (e.g., the sum of the absolute values or the energy) of the detail coefficients (horizontal, vertical, diagonal).
        3.  Assigns this summary value to the central pixel.
    * Save each output with a descriptive name (e.g., `wavelet_roughness_3px.tif`).

### Step 3: Generate Tier 2 (Process-Proxy) Covariates
* **D-infinity Flow Accumulation (Prerequisite):**
    * Use `whitebox.d_inf_flow_accumulation()` on the `dem_filled.tif`. This is the most robust flow algorithm and its output (`a`) is required for both TWI and SPI.
* **Topographic Wetness Index (TWI):**
    * **Crucially, use the specialized `dem_smoothed_for_twi.tif` as the elevation input** for `whitebox.wetness_index()`. Also provide the flow accumulation raster (`a`) as an input.
* **Stream Power Index (SPI):**
    * Use raster algebra to combine the D-infinity flow accumulation raster (`a`) and the slope raster (both derived from `dem_filled.tif`). The formula is `SPI = "a" * Tan("slope_in_radians")`.

### Step 4: Finalize and Standardize All Layers
* **Input:** All newly generated covariate rasters.
* **Process:**
    1.  **Co-registration Check:** Verify that all output rasters share the exact same grid properties (CRS, extent, cell size, alignment) as the source DEMs.
    2.  **Standardization:** Create a new directory (`data/processed/covariates/standardized/`). Loop through all continuous unstandardized rasters, calculate their mean and standard deviation, apply the z-score formula `(raster - mean) / std`, and save the result to the new directory.

## 4. Deliverables

1.  **Unstandardized Covariate Rasters:** A complete set of GeoTIFF files for each Tier 1 and Tier 2 covariate, stored in `data/processed/covariates/unstandardized/`. This includes the multiscale variants of relief and roughness.
2.  **Standardized Covariate Rasters:** A corresponding set of z-scored GeoTIFF files for all continuous covariates, stored in `data/processed/covariates/standardized/`. These will be the primary inputs for the final sampling algorithm.
3.  **Jupyter Notebook (`13_generate_covariates.ipynb`)**: A fully executed notebook documenting the entire workflow, including:
    * The defined characteristic scales.
    * The function calls and parameters for each `whitebox` tool.
    * The custom code for wavelet roughness calculation.
    * Visualizations for each key output raster to confirm successful and logical generation.


## 5. Quality Control Checklist

* [ ] The empirically-derived characteristic scales are clearly defined and used consistently.
* [ ] The correct source DEM (`filled` vs. `smoothed`) is used for each covariate.
* [ ] The multiscale covariates (relief, roughness) have been generated for all defined scales.
* [ ] TWI and SPI calculations are based on the robust D-infinity flow accumulation method.
* [ ] All output rasters are co-registered and visually inspected for correctness.
* [ ] Standardized versions have been successfully created for all continuous covariates.
* [ ] The entire workflow is reproducible via the Jupyter Notebook.