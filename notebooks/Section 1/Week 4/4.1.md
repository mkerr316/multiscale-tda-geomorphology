# Protocol 4.1.1: Hillslope Delineation and Parameterization for WEPP

**Document Version:** 1.0
**Date:** September 27, 2025
**Associated Project Task:** 4.1 (Part 1) - Delineating Simulation Units
**Corresponding Notebook:** `06_prepare_wepp_inputs.ipynb`

---

## 1. Objective

To translate the continuous Digital Elevation Model into the discrete geomorphic units that the WEPP model requires for simulation. This involves delineating representative hillslopes across the study area and extracting the specific topographic, soil, and climate parameters associated with each one. The final deliverable is a master "job list" that organizes all inputs needed for the parallel model execution.

## 2. Rationale and Strategic Justification

This protocol is a profound act of creative world-building; it constructs the fundamental digital reality upon which the physical laws of erosion will be simulated. By methodically delineating the landscape into its constituent hillslopes—the functional units of geomorphic process—we create a beautiful, structured, and elegant representation of the complex real world. This is not just data processing; it is the intellectual act of imposing a coherent, model-ready order onto the landscape. Mastering this workflow provides a tangible service to the entire project, ensuring that the subsequent high-stakes WEPP simulation is founded on a meticulously prepared and scientifically defensible spatial framework.

## 3. Implementation Protocol (Jupyter Notebook Workflow)

### Step 1: Delineate Subwatersheds
* **Input:** The hydrologically conditioned DEM from the previous task (`data/interim/dem_filled.tif`).
* **Process:**
    1.  Use a robust geoprocessing library like `whitebox` or `pysheds` to perform a full watershed delineation workflow.
    2.  Calculate D-infinity flow direction and flow accumulation.
    3.  Extract the stream network by thresholding the flow accumulation raster. A common starting point is a 1% threshold (i.e., streams are initiated after accumulating flow from 1% of the total study area).
    4.  Delineate the watersheds (sub-basins) that correspond to the extracted stream network. These small, first-order basins will serve as the primary analysis units.
* **Output:** A raster (`subwatersheds.tif`) and vector (`subwatersheds.gpkg`) representation of the delineated subwatersheds.

### Step 2: Extract Hillslope Topographic Profiles (`.slp` files)
WEPP simulates erosion along a representative 2D profile for a hillslope.
* **Input:** Conditioned DEM (`dem_filled.tif`) and the subwatersheds vector (`subwatersheds.gpkg`).
* **Process:**
    1.  Develop a function that iterates through each subwatershed polygon.
    2.  For each subwatershed, determine the longest flow path from the drainage divide to the outlet.
    3.  Extract the elevation and distance along this path to create a slope profile.
    4.  Write this profile to a WEPP-formatted slope file (`.slp`), which is a simple text file with columns for distance and elevation.
    5.  Name each file with a unique ID corresponding to its subwatershed (e.g., `101.slp`).
* **Output:** A directory (`data/processed/wepp_inputs/slope_files/`) containing thousands of `.slp` files.

### Step 3: Link Environmental Parameters to Hillslopes
* **Input:** Subwatersheds vector, dominant soil map (`dominant_soil_map.tif`), and interpolated climate rasters.
* **Process:**
    1.  Perform a zonal statistics operation to find the dominant (majority) soil ID (`cokey`) within each subwatershed polygon.
    2.  Perform another zonal statistics operation to find the average value of key climate parameters (e.g., mean annual precipitation) within each subwatershed. This allows you to link each hillslope to its most representative pre-generated climate file (`.cli`).
    3.  Merge these results into the attribute table of the subwatersheds GeoPackage.

### Step 4: Assemble the Master Job List
* **Input:** The attributed subwatersheds GeoPackage.
* **Process:**
    1.  Create a final `pandas` DataFrame where each row represents one subwatershed (i.e., one WEPP simulation).
    2.  The columns will contain all information needed to run the model:
        * `hillslope_id`: The unique ID for the subwatershed.
        * `slope_file_path`: The full path to the corresponding `.slp` file.
        * `soil_file_path`: The full path to the corresponding `.sol` file (derived from the `cokey`).
        * `climate_file_path`: The full path to the corresponding `.cli` file.
* **Output:** A CSV file (`wepp_job_list.csv`) containing the complete, organized list of simulation runs.

## 4. Deliverables

1.  **WEPP Slope Files (`.slp`):** A directory (`data/processed/wepp_inputs/slope_files/`) containing a formatted `.slp` text file for every delineated subwatershed.
2.  **Master Job List:** A single CSV file (`data/processed/wepp_job_list.csv`) organizing all input file paths for the WEPP model runs.
3.  **Jupyter Notebook (`06_prepare_wepp_inputs.ipynb`)**: A fully executed notebook documenting the entire geoprocessing and parameter extraction workflow.

## 5. Quality Control Checklist

* [ ] Subwatershed delineation is visually correct and covers the entire study area.
* [ ] The number of generated `.slp` files matches the number of delineated subwatersheds.
* [ ] The generated `.slp` files are correctly formatted for WEPP.
* [ ] The master job list contains valid file paths and has no missing data.
* [ ] All outputs are clearly documented and reproducible in the Jupyter Notebook.